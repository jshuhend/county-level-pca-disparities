---
title: "Does increased PSA screening reduce disparities in prostate cancer mortality? A county-level analysis"
authors: Jonathan Shuhendler, Mohamed Albirair MD, Ruth Etzioni PhD
output: html_document
date: "2025-01-13"
---

## Introduction

This study aims to investigate the relationship between Prostate-Specific Antigen (PSA) screening frequencies and racial disparities in prostate cancer mortality across U.S. counties. We hypothesize that counties with higher levels of screening will have lower mortality disparities.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Initial setup

First we load the relevant packages and read the data.(delta method calculations included) 

```{r}
library(tidyverse)
library(magrittr)
library(gtsummary)
library(gt)
library(usmap)
library(sf)
library(cowplot)
library(biscale)
library(ggalluvial)
library(viridis)

# may need to be adjusted for other machines...
setwd("C:/Users/jshuhend/OneDrive - Fred Hutch Cancer Center/Projects/PCa-Disparities/Data")

read_and_merge <- function(data) {
  bset <- read.csv("Behavioral_Risk_Factors__Selected_Metropolitan_Area_Risk_Trends__SMART__MMSA_Prevalence_Data__2011_to_Present__20240711.csv")
  bset <- filter(bset, Year != 2020)
  bset <- filter(bset, Response != "No")
  bset <- aggregate(cbind(Data_value, Sample_Size) ~ Locationabbr, 
                    data = bset, 
                    FUN = function(x) mean(x, na.rm = TRUE))
  bset$Data_value <- round(bset$Data_value, 3)
  bset$Sample_Size <- round(bset$Sample_Size, 0)
  colnames(bset) <- c("cbsa", "screening_frequency", "screening_sample_size")
  
  cset <- read.csv("cbsatocountycrosswalk.csv")
  cset$fipscounty <- str_pad(cset$fipscounty, width = 5, pad = "0")
  cset <- select(cset, cbsa, fipscounty)
  cset <- rename(cset, fips = fipscounty)
  cset <- na.omit(cset)
  
  mset1 <- read.csv("pca_mortality_2011_2017.csv", skip = 2)
  colnames(mset1) <- c("fips", 
                       "all_race_rate_new", 
                       "all_race_count_new", 
                       "all_race_pop_new", 
                       "white_rate_new", 
                       "white_count_new", 
                       "white_pop_new", 
                       "black_rate_new", 
                       "black_count_new", 
                       "black_pop_new", 
                       "other_ai_rate_new", 
                       "other_ai_count_new", 
                       "other_ai_pop_new", 
                       "other_uns_rate_new", 
                       "other_uns_count_new", 
                       "other_uns_pop_new"
  )
  mset1 <- select(mset1, "fips", "white_rate_new", "white_count_new", "white_pop_new", "black_rate_new", "black_count_new", "black_pop_new")
  mset1 <- mutate_all(mset1, ~na_if(., "^"))
  mset1$fips <- str_extract(mset1$fips, "\\d{5}")
  mset1 <- na.omit(mset1)
  mset1$white_rate_new <- parse_number(mset1$white_rate_new)
  mset1$black_rate_new <- parse_number(mset1$black_rate_new)
  mset1$mort_ratio_new <- mset1$black_rate_new / mset1$white_rate_new
  
  mset2 <- read.csv("pca_mortality_1984_1989.csv", skip = 2)
  colnames(mset2) <- c("fips", 
                       "all_race_rate_old", 
                       "all_race_count_old", 
                       "all_race_pop_old",
                       "white_rate_old", 
                       "white_count_old", 
                       "white_pop_old", 
                       "black_rate_old", 
                       "black_count_old", 
                       "black_pop_old", 
                       "other_ai_rate_old", 
                       "other_ai_coun_oldt", 
                       "other_ai_pop_old", 
                       "other_uns_rate_old", 
                       "other_uns_count_old", 
                       "other_uns_pop_old"
  )
  mset2 <- select(mset2, "fips", "white_rate_old", "white_count_old", "white_pop_old", "black_rate_old", "black_count_old", "black_pop_old")
  mset2 <- mutate_all(mset2, ~na_if(., "^"))
  mset2$fips <- str_extract(mset2$fips, "\\d{5}")
  mset2 <- na.omit(mset2)
  mset2$white_rate_old <- parse_number(mset2$white_rate_old)
  mset2$black_rate_old <- parse_number(mset2$black_rate_old)
  mset2$mort_ratio_old <- mset2$black_rate_old / mset2$white_rate_old
  
  sset1 <- read.csv("SVI_2014_US_county.csv")
  sset1$fips <- str_pad(as.character(sset1$FIPS), width = 5, pad = "0")
  sset1 <- select(sset1, "fips", "EP_POV", "EP_UNEMP", "EP_NOHSDP", "EP_UNINSUR")
  
  sset2 <- read.csv("SVI_2016_US_county.csv")
  sset2$fips <- str_pad(as.character(sset2$FIPS), width = 5, pad = "0")
  sset2 <- select(sset2, "fips", "EP_POV", "EP_UNEMP", "EP_NOHSDP", "EP_UNINSUR")
  
  sset3 <- read.csv("SVI_2018_US_county.csv")
  sset3$fips <- str_pad(as.character(sset3$FIPS), width = 5, pad = "0")
  sset3 <- select(sset3, "fips", "EP_POV", "EP_UNEMP", "EP_NOHSDP", "EP_UNINSUR")
  sset3 <- sset3 |> filter(fips != "35039")                                           # removed this county due to abnormal data in EP_POV and EP_UNEMP (both had value -999.0)
  
  sset <- bind_rows(sset1, sset2, sset3)
  
  sset <- group_by(sset, fips)
  sset <- summarize(
    sset,
    avg_poverty = mean(EP_POV, na.rm = TRUE),
    avg_unemployment = mean(EP_UNEMP, na.rm = TRUE),
    avg_nohsdp = mean(EP_NOHSDP, na.rm = TRUE),
    avg_uninsured = mean(EP_UNINSUR, na.rm = TRUE),
    .groups = "drop"
  )
  
  dset <- full_join(bset, cset, by = "cbsa")
  dset <- full_join(dset, mset1, by = "fips")
  dset <- full_join(dset, mset2, by = "fips")
  dset <- full_join(dset, sset, by = "fips")
  
  # old mortality new mortality difference
  dset$diff <- abs(dset$mort_ratio_old - dset$mort_ratio_new)
  
  # delta method calculation
  dset$white_count_new <- parse_number(dset$white_count_new)
  dset$white_pop_new <- parse_number(dset$white_pop_new)
  dset$black_count_new <- parse_number(dset$black_count_new)
  dset$black_pop_new <- parse_number(dset$black_pop_new)
  dset$white_variance_new <- dset$white_count_new / dset$white_pop_new ^ 2 * 1e5 ^ 2
  dset$black_variance_new <- dset$black_count_new / dset$black_pop_new ^ 2 * 1e5 ^ 2
  dset$variance_ratio_new <- 1/dset$black_rate_new ^ 2 * dset$white_variance_new + 1/dset$white_rate_new ^ 2 * dset$black_variance_new
  
  dset$white_count_old <- parse_number(dset$white_count_old)
  dset$white_pop_old <- parse_number(dset$white_pop_old)
  dset$black_count_old <- parse_number(dset$black_count_old)
  dset$black_pop_old <- parse_number(dset$black_pop_old)
  dset$white_variance_old <- dset$white_count_old / dset$white_pop_old ^ 2 * 1e5 ^ 2
  dset$black_variance_old <- dset$black_count_old / dset$black_pop_old ^ 2 * 1e5 ^ 2
  dset$variance_ratio_old <- 1/dset$black_rate_old ^ 2 * dset$white_variance_old + 1/dset$white_rate_old ^ 2 * dset$black_variance_old
  
  return(dset)
}

dset <- read_and_merge(data)
```

## Overall trends of PCa mortality (black and white)

We visualize the overall mortality rates of black and white men in SEER with a simple line graph from 1980 to 2019. We add a vertical line at 1990 to delineate when PSA screening became widespread in the US

```{r}
setwd("C:/Users/jshuhend/OneDrive - Fred Hutch Cancer Center/Projects/PCa-Disparities/Data")

trends <- read.csv("1980_2019_mort.csv", skip = 1)
colnames(trends) <- c("year", "whiterate", "whitecount", "whitepop", "blackrate", "blackcount", "blackpop")

ovrtrend <- ggplot(trends, aes(x = year)) +
  geom_line(aes(y = whiterate, color = "White Rate"), linewidth = 1.2) +
  geom_line(aes(y = blackrate, color = "Black Rate"), linewidth = 1.2) +
  labs(x = "Year", y = "Rate", title = "Figure 1 \n\n Prostate Cancer Mortality Rates by Race (1980-2019)") +
  scale_color_manual(name = "Race", values = c("White Rate" = "#27408B", "Black Rate" = "#FFB90F"),
                     labels = c("Black", "White")) +
  ylim(0, max(trends$whiterate, trends$blackrate)) +  
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5,size = 17, face = "bold"), 
    axis.title.x = element_text(size = 14, hjust = 0.51),  
    axis.title.y = element_text(size = 14, hjust = 0.52), 
  ) +
  geom_vline(xintercept = 1990, linetype = "dashed", color = "black", size = 1) +
  annotate("text", x = 1990, y = 25, 
           label = "Widespread PSA\n screening use", angle = 0, hjust = -0.075, size = 5, color = "black")

ovrtrend
```

## Maps (exploratory)

We create maps to visualize our data, both for screening and mortality, at the county-level

# County-level map showing mortality rate ratios (2011-2017) 
 
```{r}
mapmset <- select(dset, fips, mort_ratio_new)
mapmset <- na.omit(mapmset) 

plot_usmap(
  linewidth = 0.025,        
  color = "gray60",          
  regions = "counties",     
  data = mapmset,
  values = "mort_ratio_new",
  exclude = c("AK", "HI")   
) +
  scale_fill_gradient(
    name = "Black-to-White mortality ratio", 
    high = "darkblue",
    low = "white",
    limits = c(0, 6),  
    guide = guide_colorbar(
      title.position = "top",           
      title.hjust = 0.5,                
      barwidth = 15,                    
      barheight = 0.5                  
    )
  ) +
  labs(title = "County-Level Prostate Cancer Mortality Disparities (2011-2017)") +
  theme_void() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"), 
    text = element_text(size = 14)
  )
```

# County-level map showing screening frequencies (2012+2014+2016+2018 - averaged) 

```{r}
mapsset <- select(dset, fips, screening_frequency)
mapsset <- na.omit(mapsset)
mapsset$screening_frequency <- mapsset$screening_frequency / 10

plot_usmap(
  linewidth = 0.025,        
  color = "gray60",            
  regions = "counties",     
  data = mapsset,
  values = "screening_frequency",
  exclude = c("AK", "HI")   # exclude Alaska and Hawaii
  ) +
  scale_fill_gradient(
    name = "Screening rate (by 10%)", 
    high = "red",
    low = "yellow",
    limits = c(2, 7),  
    guide = guide_colorbar(
      title.position = "top",          
      title.hjust = 0.5,                
      barwidth = 15,                    
      barheight = 0.5                   
    )
  ) +
  labs(title = "County-Level PSA Screening Frequencies (2012, 2014, 2016 and 2018)") +
  theme_void() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 17, face = "bold"), 
    text = element_text(size = 14)
  )
```

# Bivariate map showing both mortality and screening (not very informative, included for reference)

```{r}
county_data <- us_map("counties")

biv <- full_join(dset, county_data)
biv <- drop_na(biv)

a <- bi_class(biv, x = mort_ratio_new, y = screening_frequency, style = "quantile", dim = 3)
a <- st_as_sf(a)

# map 
map <- plot_usmap(
  linewidth = 0.025, color = "gray75", regions = "counties") +
  geom_sf(data = a, mapping = aes(fill = bi_class), color = "white", size = 0.01, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet", dim = 3) +
  labs(
    title = "Black vs. White Mortality Ratio and Average Screening Percent by US County"
  ) +
  biscale::bi_theme() +
  theme(plot.title = element_text(size = 8))

# legend
legend <- bi_legend(pal = "DkViolet",               
                    dim = 3,
                    xlab = "Higher Rate of Black to White Mortality ",
                    ylab = "Higher Sceening Prevalence ",
                    size = 1)

legend <- legend + theme(axis.title = element_text(size = 3))    #adjusting the font size on legend, still a bit hard to read 

# map and legend
finalPlot <- ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +      #position of map
  draw_plot(legend, 0.05, 0.1, .15, 1)    #position of legend
print(finalPlot)
```

## Screening frequencies flowchart (exploratory)

We produce an alluvial plot to show the consistency (or lack thereof) of screening frequencies by county

```{r}
setwd("C:/Users/jshuhend/OneDrive - Fred Hutch Cancer Center/Projects/PCa-Disparities/Data")

scr <- read.csv("Behavioral_Risk_Factors__Selected_Metropolitan_Area_Risk_Trends__SMART__MMSA_Prevalence_Data__2011_to_Present__20240711.csv")

scr <- filter(scr, Year != 2020, Response != "No")
scr <- select(scr, Year, Locationabbr, Data_value, Sample_Size)
scr <- scr |> group_by(Year) 
scr <- scr |> mutate(quartile = ntile(Data_value, 2)) 
scr <- scr |> ungroup()
scr <- filter(scr, Year %in% c(2012, 2018))

baseline_2012 <- scr |> filter(Year == 2012) 
baseline_2012 <- baseline_2012 |> select(Locationabbr, quartile) 
baseline_2012 <- baseline_2012 |> rename(baseline = quartile)

scr <- left_join(scr, baseline_2012, by = "Locationabbr")
scr <- scr |> group_by(Locationabbr) 
scr <- scr |> filter(n_distinct(Year) == 2) 
scr <- scr |> ungroup()
scr <- select(scr, Year, Locationabbr, quartile, baseline)
scr <- na.omit(scr)

gg_theme <- function(...){
  theme_set(theme_classic())
  theme_update(axis.text=element_text(color='black'),
               axis.ticks.length=unit(0.2, 'cm'),
               strip.text=element_text(color='black', size=9),
               strip.background=element_rect(color=NA, fill=NA))
  theme_update(...)
}

scr_alluvial_plot <- function(scr){
  
  gg_theme(legend.position='none',
           axis.line.y=element_blank(),
           axis.ticks.y=element_blank(),
           axis.text=element_text(color='black', size=14),  # Increase label size
           axis.text.y=element_blank())  # Remove y-axis text
  
  scr$Year <- as.factor(scr$Year)
  scr$quartile <- as.factor(scr$quartile)
  gg <- ggplot(scr, aes(x=Year,
                        stratum=quartile,
                        alluvium=Locationabbr,
                        fill=quartile,  
                        label=quartile))
  gg <- gg + geom_alluvium(aes(fill = quartile))
  gg <- gg + geom_stratum(aes(fill = quartile), alpha = 0, size = 1, width = 0.25)
  gg <- gg + geom_text(stat='stratum', aes(label=ifelse(quartile == 1, 'Top 50%', 
                                                        ifelse(quartile == 2, 'Bottom 50%', quartile))), 
                       size=6)  
  gg <- gg + scale_x_discrete(name='', expand=c(0, 0))
  gg <- gg + scale_y_continuous(expand=c(0, 0), breaks=NULL, labels=NULL)
  gg <- gg + scale_fill_manual(values = c('#E69F00', '#480082'))  
  
  print(gg)
}

scr_alluvial_plot(scr)
```

## Regressions

We quantify the associations between mortality disparities (calculated as black rate/white rate), PSA screening and other social determinants of health (SDOH) variables using multi-variable regression (weighted via delta method)

# Regression for 2011-2017 mortality disparity vs screening and sdoh

```{r}
rnset <- select(dset, mort_ratio_new, screening_frequency, avg_poverty, avg_unemployment, avg_nohsdp, avg_uninsured, variance_ratio_new)
rnset$screening_frequency <- rnset$screening_frequency / 10
rnset <- na.omit(rnset)

model_new <- lm(mort_ratio_new ~ screening_frequency + avg_poverty + avg_unemployment + avg_nohsdp + avg_uninsured, 
                data = rnset, 
                weights = 1 / variance_ratio_new)

#summary(model_new)

t1 <- tbl_regression(model_new, label = list(screening_frequency ~ "Screening Frequency", avg_poverty ~ "Poverty Rate", avg_unemployment ~ "Unemployment Rate", avg_nohsdp ~ "No High School Diploma Rate", avg_uninsured ~ "No Health Insurance Rate"))

t1
```

# Regression for 1986-1989 mortality disparity vs screening

```{r}
roset <- select(dset, mort_ratio_old, screening_frequency, avg_poverty, avg_unemployment, avg_nohsdp, avg_uninsured, variance_ratio_old)
roset$screening_frequency <- roset$screening_frequency / 10
roset <- na.omit(roset)

model_old <- lm(mort_ratio_old ~ screening_frequency, 
                data = roset, 
                weights = 1 / variance_ratio_old)

#summary(model_old)

t2 <- tbl_regression(model_old, label = list(screening_frequency ~ "Screening Frequency"))

t2
```

# Regression with the difference in mortality ratio from the pre PSA era and the PSA era as the dependent variable

```{r}
# how to weight?
rdset <- select(dset, diff, screening_frequency)

model_diff <- lm(diff ~ screening_frequency,
                 data = rdset,
                 weights = 1 / #variance ratio old? variance ratio new?)

t3 <- tbl_regression(model_diff)

t3
```

## Scatter plots

We visualize the associations using scatter plots (weighted)

# Screening vs mortality (2011-2017)

```{r}
scatter_plot_1 <- ggplot(dset, aes(x = screening_frequency, y = mort_ratio_new, size = 1/variance_ratio_new)) +
  geom_point(color = "black", alpha = 0.57) + 
  geom_smooth(method = "lm", aes(weight = 1 / variance_ratio_new), se = FALSE, linewidth = 1.25) +
  labs(
    x = "Screening Frequency",
    y = "Mortality Rate Ratio (B/W)",
    title = "Figure 2 \n\n County Level Screening Frequencies (2012-2018) vs. Mortality Rate Ratios (2011-2017)"
  ) +
  theme_classic() +  
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5, margin = margin(b = 20)),   
    axis.title = element_text(size = 12, face = "bold"),                
    axis.text = element_text(size = 16),                                 
    plot.margin = margin(t = 22, r = 10, b = 30, l = 14),
    legend.position = 'none'
  ) 

scatter_plot_1
```

# Screening vs mortality (1984-1989)

```{r}
scatter_plot_2 <- ggplot(dset, aes(x = screening_frequency, y = mort_ratio_old, size = 1/variance_ratio_old)) +
  geom_point(color = "darkblue", alpha = 0.57) + 
  geom_smooth(method = "lm", aes(weight = 1 / variance_ratio_old), se = FALSE, linewidth = 1.25, color = "orange") +
  labs(
    x = "Screening Frequency",
    y = "Mortality Rate Ratio (B/W)",
    title = "Figure 3 \n\n County Level Screening Frequencies (2012-2018) vs. Mortality Rate Ratios (2011-2017)"
  ) +
  theme_classic() +  
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5, margin = margin(b = 20)),   
    axis.title = element_text(size = 12, face = "bold"),                
    axis.text = element_text(size = 16),                                 
    plot.margin = margin(t = 22, r = 10, b = 30, l = 14),
    legend.position = 'none'
  ) 

scatter_plot_2
```
